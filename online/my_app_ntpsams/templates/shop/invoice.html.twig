{% extends 'theme/temp.html.twig' %}

{% block title %}Invoice - {{ payment_id }}{% endblock %}


{% block stylesheets %}
    <style>
        /* CSS minimal maintenu pour l'impression et les ajustements non-Bootstrap */
        body { font-family: 'Helvetica Neue', 'Helvetica', Arial, sans-serif; }

        /* Utilisation d'un conteneur Bootstrap pour la largeur max, mais avec un ombrage customisé */
        .invoice-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border: 1px solid #eee;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            background: #fff;
        }

        /* Ajustement des lignes de total */
        .total-row td {
            font-size: 1.2em;
            font-weight: bold;
            border-top: 2px solid #333 !important; /* Utiliser !important si nécessaire */
        }

        /* Media Query pour l'impression */
        @media print {
            .no-print { display: none; }
            /* Réduit les marges à l'impression */
            body { padding: 0; margin: 0; }
            .invoice-container { box-shadow: none; border: none; margin: 0; max-width: 100%; }
        }
    </style>
{% endblock %}



{% block body %}
    {% set subtotal_price = 0 %}

    <br>
    {# Utilisation des classes Bootstrap pour le padding et la marge #}
    <div class="invoice-container">

        {# L'en-tête de la facture : Utilise la grille Bootstrap pour être responsive #}
        <div class="row invoice-header border-bottom border-2 pb-2 mb-4 align-items-center">

            {# Bloc Gauche : Titre et ID (Prend 6 colonnes sur les appareils moyens et plus) #}
            <div class="col-md-6">
                <h1 class="h3 fw-bold">INVOICE</h1>
                <p class="text-muted mb-0">Ref: #{{ transaction_details.payment_id }}</p>
            </div>

            {# Bloc Droit : Infos Entreprise (Prend 6 colonnes, aligné à droite sur les grands écrans) #}
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <h2 class="h5 fw-bold mb-1">NTPSAMS-TECHNOLOGY</h2>
                <p class="mb-0">{{ func_pageinfo()['addfull'] |raw }}</p>
                <p class="mb-0">Contact : {{ func_pageinfo().infomail }} | {{ func_pageinfo().phone1 }}</p>
            </div>
        </div>

        {# Détails de la facture : Facturé à / Date de la facture #}
        <div class="row mb-5">

            {# Bloc Gauche : Billed To: (col-md-6) #}
            <div class="col-md-6">
                <h4 class="fw-bold text-primary">Billed To:</h4>
                {% set client = order_details.client_info %}
                <p class="mb-1 fw-bold">
                    {{ client.customer_firstname }} {{ client.customer_name }}
                </p>
                <p class="mb-1">
                    {# Affichage conditionnel de l'adresse #}
                    {% if client.customer_address_full is not empty %}
                        {{ client.customer_address_full }}<br>
                    {% endif %}

                    {% if client.customer_city is not empty %}
                        {{ client.customer_city }}<br>
                    {% endif %}

                    {% if client.customer_email is not empty %}
                        {{ client.customer_email }}
                    {% endif %}
                </p>
            </div>

            {# Bloc Droit : Détails (col-md-6, aligné à droite sur les écrans moyens et plus) #}
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <h4 class="fw-bold text-primary">Invoice Details:</h4>
            <p class="mb-1"><strong>Date:</strong> {{ transaction_details.created_at|date('m/d/Y') }}</p>
            <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">{{ transaction_details.status }}</span></p>
            <p class="mb-1"><strong>Payment:</strong> {{ transaction_details.payment_method|capitalize }}</p>
            </div>
        </div>

        {# Tableau des articles : Utilisation des classes Bootstrap 5 pour le tableau #}
        <div class="table-responsive mb-5">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                <tr>
                    <th>Item</th>
					<th class="text-center">Qty</th>
					<th class="text-end">Unit Price ({{ currency }})</th>
					<th class="text-end">Total ({{ currency }})</th>
                </tr>
                </thead>
                <tbody>
                {% for item in order_details.items %}
                    {% set price_for_display = item.price_cents / 100 %}
                    {% set item_total = price_for_display * item.qty %}
                    {% set subtotal_price = subtotal_price + item_total %}

                    <tr>
                        <td>{{ item.name }}</td>
                        <td class="text-center">{{ item.qty }}</td>
                        <td class="text-end">{{ price_for_display|number_format(2, '.', ',') }}</td>
                        <td class="text-end">{{ item_total|number_format(2, '.', ',') }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                {% set tax_rate = transaction_details.tax_rate %}
                {% set tax_amount = subtotal_price * tax_rate %}
                {% set total_price = subtotal_price + tax_amount %}

                <tr>
                    <td></td>
                    <td></td>
                </tr>

                <tr>
                    <td colspan="3" class="text-end fw-bold">Subtotal ({{ currency }})</td>
                    <td class="text-end">{{ subtotal_price|number_format(2, '.', ',') }} {{ currency }}</td>
                </tr>
                <tr>
                    <td colspan="3" class="text-end fw-bold">Tax ({{ (tax_rate * 100)|number_format(1) }}% Incl. Tax)</td>
                    <td class="text-end">{{ tax_amount|number_format(2, '.', ',') }} {{ currency }} </td>
                </tr>
                <tr class="total-row table-primary">
                    <td colspan="3" class="text-end">Total Incl. Tax</td>
                    <td class="text-end">{{ total_price|number_format(2, '.', ',') }} {{ currency }}</td>
                </tr>
                </tfoot>
            </table>
        </div>


        <div class="footer no-print text-center border-top pt-3 mt-4">
			<p class="text-light">Thank you for your purchase!</p>
			<button onclick="window.print()" class="btn btn-dark btn-lg">
				<i class="bi bi-printer"></i> Print Invoice
			</button>
		</div>
    </div>
{% endblock %}
